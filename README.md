# Ozon Telegram Bot

NestJS‑бот, который автоматизирует оформление поставок в Ozon. Пользователь подключает бота, загружает таблицу с товарами и проходит интерактивный мастер: выбор пункта сдачи, кластера, склада, таймслота и даты готовности. После подтверждения бот сохраняет задачу в SQLite и в фоне доводит поставку до статуса «создана».

## Возможности
- **Интерактивный мастер** (`/start`): загрузка Excel/Google Sheets, поиск drop‑off по тексту, выбор кластера и склада с пагинацией и фильтром, автоматическое подтягивание таймслотов, выбор готовности к отгрузке (клавиатура или ручной ввод).
- **Работа с Ozon API**: все запросы идут через `OzonApiService` (авторизация, ретраи, логирование). Черновики и таймслоты создаются в фоне с учётом отмены.
- **Фоновая обработка задач**: после подтверждения мастер сохраняет поставку в SQLite (`supply_orders`), а сервис `SupplyTaskRunnerService` продолжает поллинг API, создаёт поставку и обновляет статус.
- **Управление ключами**: команды `/ozon_auth`, `/ozon_keys`, `/ozon_clear`. Ключи лежат в SQLite (`user_credentials`), а в ответах бота маскируются.
- **Админ‑уведомления**: сервис `AdminNotifierService` транслирует события мастера (авторизация, ошибки, создание поставок) в список администраторов.

## Как проходит мастер поставки
1. **Загрузка файла** — Excel/Google Sheet с товарами (Артикул + Количество). Бот вычитывает данные, валидирует позиции и запрашивает пункт сдачи.
2. **Поиск drop‑off** — можно отправить текстовый запрос, бот предложит совпадения, пагинация не требуется.
3. **Выбор кластера** — бот показывает список кластеров. После клика дополнительно тянет `/v1/cluster/list` с `cluster_id`, чтобы получить актуальные склады.
4. **Выбор склада** — клавиатура с 10 позициями на страницу, стрелки «⬅️/➡️», кнопка «Сбросить поиск» и «← Выбрать другой кластер». Допускается текстовый фильтр (по названию или ID склада).
5. **Получение таймслотов** — бот создаёт или переиспользует черновик, получает список складов/таймслотов из API и уведомляет о выбранном таймслоте.
6. **Готовность к отгрузке** — клавиатура с популярными вариантами (0, 2, 3, 5, 7, 10, 14, 21, 28 дней) + возможность ввести своё значение (2–28). Бот запоминает выбор и запускает фоновую обработку.
7. **Фоновый прогресс** — задача попадает в `/supply_orders`, бот информирует админов о событиях (`draftCreated`, `timeslotMissing`, `supplyCreated` и т.д.). При отмене пользователь может удалить задачу, и бот корректно останавливает поллинг.

## Команды бота

| Команда | Описание |
| ------- | -------- |
| `/start` | Запустить мастер оформления поставки |
| `/help` | Показать краткую инструкцию по шагам |
| `/ping` | Проверить доступность бота |
| `/ozon_auth <CLIENT_ID> <API_KEY>` | Сохранить ключи Ozon (используются для всех запросов) |
| `/ozon_keys` | Показать маскированные ключи и дату последней валидации |
| `/ozon_clear` | Очистить ключи и сразу открыть мастер |

Документы и любой свободный текст внутри мастера трактуются по текущему шагу: поиск drop‑off, фильтр складов или ввод готовности.

## Структура проекта
```
apps/
  bot-api/
    src/
      app.module.ts          # корневой модуль NestJS
      main.ts                # bootstrap Telegraf + Nest
      bot/                   # Telegram-обработчики, мастер поставки, хранилища
      config/                # сервисы конфигурации и Ozon API
      health/                # health-check контроллер
      ozon/                  # доменные сервисы работы с поставками
      storage/               # TypeORM сущности и хранилища (SQLite)
infra/
  Dockerfile                 # multi-stage образ на Node 20
.github/workflows/ci.yml     # проверка сборки + публикация Docker-образа
data/bot.sqlite              # SQLite (создаётся автоматически в dev)
```

## Окружение и зависимости
- Node.js 20+
- Yarn Classic (1.x, активируется через Corepack)
- SQLite (файл создаётся автоматически)
- Docker (опционально, для продакшн-образа)

### Настройка окружения
```bash
cp .env.example .env
```
Обязательные переменные:
- `TELEGRAM_BOT_TOKEN` — токен бота.
- `OZON_CLIENT_ID`, `OZON_API_KEY` — дефолтные ключи (используются, если пользователь не авторизовался). Можно оставить пустыми.
- `WEBHOOK_DOMAIN`, `WEBHOOK_PATH` — нужны только в production (webhook).
- `DATABASE_PATH` / `OZON_SUPPLY_*` — при необходимости переопределяют SQLite и параметры работы мастера (drop-off, интервал поллинга).

**Важно:** `.env` не коммитим, реальные секреты храним в безопасном хранилище.

## Локальная разработка
```bash
yarn install
yarn start:dev
```
В `NODE_ENV=development` бот работает в режиме long polling и создаёт `data/bot.sqlite`. Для отладки мастера достаточно загрузить тестовый Excel и пройти шаги.

Полезные команды:
- `yarn build` — компиляция TypeScript в `dist/`.
- `yarn start` — запуск уже собранного приложения.
- `yarn lint` / `yarn format` — при необходимости можно добавить скрипты (не настроены по умолчанию).

## Production
1. Соберите код: `yarn build`.
2. Задайте `NODE_ENV=production`, `WEBHOOK_DOMAIN`, `WEBHOOK_PATH` и переменные с ключами.
3. Запустите `node dist/apps/bot-api/main.js` — Telegraf поднимет webhook.

### Docker
```bash
docker build -f infra/Dockerfile -t ozon-bot .
docker run --rm \
  -e NODE_ENV=production \
  -e TELEGRAM_BOT_TOKEN=... \
  -e WEBHOOK_DOMAIN=https://example.com \
  -e WEBHOOK_PATH=/telegram \
  -e OZON_CLIENT_ID=... \
  -e OZON_API_KEY=... \
  -p 3000:3000 \
  ozon-bot
```

## CI/CD
Workflow `.github/workflows/ci.yml`:
1. Устанавливает Node 20 и активирует Corepack.
2. Кеширует зависимости Yarn.
3. Запускает `yarn install --frozen-lockfile` и `yarn build`.
4. Собирает Docker-образ из `infra/Dockerfile`.
5. Публикует образ в GHCR (`ghcr.io/<owner>/<repo>/bot-api:latest` и `:sha`) при пушах в `main`.

## Хранилище данных
- `user_credentials` (TypeORM) — чатовые ключи Ozon, хранятся маскированно, `clientId`/`apiKey` очищаются по `/ozon_clear`.
- `supply_orders` — сведения о задачах и поставках (payload из мастера + статусы). На отмену бот удаляет запись и прерывает фоновые запросы.

## Советы по разработке
- Поддерживайте чистый state: при переходе между кластерами/складами сбрасывайте поисковые запросы и страницу.
- Любая интеграция с Ozon должна идти через `OzonApiService` — там настроены ретраи и логирование.
- Если добавляете новые шаги мастера — обновляйте документацию и help‑сообщение.
- Не забывайте маскировать пользовательские ключи в логах и ответах.

Готово! Теперь README отражает фактические шаги мастера и текущее устройство проекта. успользуйте `/start`, чтобы пройти обновлённый сценарий и проверить бизнес-логику. 
